<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
    <style>
        :root { --primary: #0070f3; --error: #ff4d4f; --success: #28a745; }
        body { font-family: -apple-system, sans-serif; background: #f8f9fa; color: #333; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .policy-box { background: #f0f7ff; border: 1px solid #cce5ff; padding: 15px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 20px; }
        #drop-zone { border: 2px dashed #ccc; border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; background: #fafafa; }
        #status { margin-top: 20px; text-align: center; font-weight: bold; }
        #preview-area { display: none; margin-top: 30px; text-align: center; }
        video { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
        .btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; text-decoration: none; font-size: 14px; }
        .btn-dl { background: var(--success); color: white; }
        .btn-tw { background: #000; color: white; }
        .error-text { color: var(--error); padding: 10px; background: #fff1f0; border-radius: 5px; border: 1px solid var(--error); }
    </style>
</head>
<body>

<div class="container">
        <h1>é™æ­¢ç”»ãƒ¡ãƒ¼ã‚«ãƒ¼<h1>
    <div class="policy-box">
        å‡¦ç†ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§è¡Œã‚ã‚Œã€ç”»åƒãŒã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã•ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ¨©åˆ©ã¯åˆ©ç”¨è€…ã«å¸°å±ã—ã¾ã™ã€‚
    </div>
    
    <div id="drop-zone">ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã€ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯</div>
    <input type="file" id="file-input" accept="image/*" style="display: none;">

    <div id="status"></div>

    <div id="preview-area">
        <video id="output-video" controls loop></video>
        <div class="btn-group">
            <a id="download-link" class="btn btn-dl">ä¿å­˜ã™ã‚‹</a>
            <a id="tweet-link" class="btn btn-tw" target="_blank">ğ•ã§ã‚·ã‚§ã‚¢</a>
        </div>
        <p><button onclick="location.reload()">åˆ¥ã®ç”»åƒã«ã™ã‚‹</button></p>
    </div>
</div>

<script>
    const { FFmpeg } = FFmpegWASM;
    const { fetchFile, toBlobURL } = FFmpegUtil;
    let ffmpeg = null;
    const AI_KEYWORDS = ["stable diffusion", "midjourney", "dall-e", "novelai", "adobe firefly", "comfyui", "automatic1111"];

    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');
    const status = document.getElementById('status');

    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => handleUpload(e.target.files[0]);
    dropZone.ondragover = (e) => e.preventDefault();
    dropZone.ondrop = (e) => { e.preventDefault(); handleUpload(e.dataTransfer.files[0]); };

    async function handleUpload(file) {
        if (!file) return;
        status.innerText = "è§£æä¸­...";
        
        const text = await file.slice(0, 512 * 1024).text();
        if (AI_KEYWORDS.some(kw => text.toLowerCase().includes(kw))) {
            status.innerHTML = `<div class="error-text">AIç”Ÿæˆã®ç–‘ã„ãŒã‚ã‚‹ãŸã‚ã€ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ã€‚</div>`;
            return;
        }

        try {
            await generateVideo(file);
        } catch (e) {
            status.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦è©¦ã—ã¦ãã ã•ã„ã€‚";
            console.error(e);
        }
    }

    async function generateVideo(file) {
        status.innerText = "ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•ä¸­...";
        if (!ffmpeg) {
            ffmpeg = new FFmpeg();
            const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd';
            await ffmpeg.load({
                coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
            });
        }

        const img = new Image();
        img.src = URL.createObjectURL(file);
        await img.decode();
        const w = img.width, h = img.height;

        status.innerText = "é«˜å“è³ªã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ä¸­...";
        await ffmpeg.writeFile('input', await fetchFile(file));
        await ffmpeg.exec(['-loop','1','-i','input','-t','1','-c:v','libx264','-crf','18','-pix_fmt','yuv420p','-vf','scale=trunc(iw/2)*2:trunc(ih/2)*2','out.mp4']);
        
        const data = await ffmpeg.readFile('out.mp4');
        const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));

        status.innerText = "ç”Ÿæˆå®Œäº†ï¼";
        document.getElementById('output-video').src = url;
        document.getElementById('preview-area').style.display = "block";
        document.getElementById('download-link').href = url;
        document.getElementById('download-link').download = `video.mp4`;
        document.getElementById('tweet-link').href = `https://twitter.com/intent/tweet?text=${encodeURIComponent("ç”»åƒã‚’1ç§’å‹•ç”»ã«å¤‰æ›ã—ã¾ã—ãŸ")}`;
    }
</script>
</body>
</html>
