<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ルート共有画像合成ツール</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #ffeef5;
      display: flex;
      gap: 20px;
      justify-content: center;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .controls, .preview-area {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      flex: 1;
      max-width: 500px;
    }
    .preview-area h3 { text-align: center; }
    .drop-zone {
      border: 2px dashed #e699b2;
      padding: 20px;
      text-align: center;
      margin-bottom: 10px;
      color: #555;
      cursor: pointer;
      border-radius: 8px;
    }
    .preview-thumb {
      max-width: 100px;
      max-height: 100px;
      display: none;
      margin: 10px auto;
    }
    input[type="file"] { display: none; }
    #canvas { display: none; }
    #preview { max-width: 100%; height: auto; border: 1px solid #ccc; margin-bottom: 20px; display:none; }
    .qr-group { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .qr-input-group { width: calc(50% - 10px); }
    .slider-group { width: 100%; margin-top: 5px; text-align: left; }
    input[type="range"] { width: 100%; height: 25px; }
    #downloadButton {
      padding: 12px 20px;
      font-size: 16px;
      width: 180px;
      background: linear-gradient(45deg, #ff9abb, #ff6fa5);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
      display: none;
    }
    #downloadButton:hover { background: linear-gradient(45deg, #ff6fa5, #e6558c); }
    .reset-btn {
      padding: 10px 20px;
      font-size: 16px;
      width: 180px;
      background-color: #e60033;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .reset-btn:hover { background-color: #b30024; }
    .controls-group { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <div class="controls">
    <h2>背景画像</h2>
    <div class="drop-zone" id="mainDrop">背景画像をここにドロップまたはクリック</div>
    <input type="file" accept="image/*" id="mainInput">
    <img id="mainThumb" class="preview-thumb" alt="背景画像プレビュー"><br>

    <hr>
    <h3>QRコード</h3>
    <label for="modeSelect">モード選択:</label>
    <select id="modeSelect">
      <option value="2">2枚モード（左右のみ）</option>
      <option value="4">4枚モード</option>
    </select>

    <div id="qr-top-row" class="qr-group">
      <div class="qr-input-group">
        <label for="leftTopText">テキスト:</label>
        <input type="text" id="leftTopText" value="先１">
        <div class="drop-zone" id="leftTopDrop">左上QR画像</div>
        <input type="file" accept="image/*" id="leftTopInput">
        <img id="leftTopThumb" class="preview-thumb" alt="左上QRプレビュー"><br>
      </div>
      <div class="qr-input-group">
        <label for="rightTopText">テキスト:</label>
        <input type="text" id="rightTopText" value="後１">
        <div class="drop-zone" id="rightTopDrop">右上QR画像</div>
        <input type="file" accept="image/*" id="rightTopInput">
        <img id="rightTopThumb" class="preview-thumb" alt="右上QRプレビュー"><br>
      </div>
    </div>

    <div id="qr-bottom-row" class="qr-group">
      <div class="qr-input-group">
        <label for="leftQRText">テキスト:</label>
        <input type="text" id="leftQRText" value="先２">
        <div class="drop-zone" id="leftQRDrop">左下QR画像</div>
        <input type="file" accept="image/*" id="leftQRInput">
        <img id="leftThumb" class="preview-thumb" alt="左下QRプレビュー"><br>
      </div>
      <div class="qr-input-group">
        <label for="rightQRText">テキスト:</label>
        <input type="text" id="rightQRText" value="後２">
        <div class="drop-zone" id="rightQRDrop">右下QR画像</div>
        <input type="file" accept="image/*" id="rightQRInput">
        <img id="rightThumb" class="preview-thumb" alt="右下QRプレビュー"><br>
      </div>
    </div>
  </div>

  <div class="preview-area">
    <h3>合成画像プレビュー</h3>
    <img id="preview" alt="合成画像プレビュー">

    <div class="controls-group">
      <label><input type="checkbox" id="toggleText" checked> テキストを表示</label>
      <label for="textColorPicker">テキスト色</label>
      <input type="color" id="textColorPicker" value="#000000">
    </div>

    <div id="slider-left" class="slider-group">
      <label for="left-qr-offset">左QR位置調整</label>
      <input type="range" id="left-qr-offset" min="-700" max="800" value="0">
    </div>
    <div id="slider-right" class="slider-group">
      <label for="right-qr-offset">右QR位置調整</label>
      <input type="range" id="right-qr-offset" min="-1200" max="200" value="0">
    </div>
    <div id="slider-top" class="slider-group">
      <label for="top-qr-vertical-offset">上QR位置調整</label>
      <input type="range" id="top-qr-vertical-offset" min="-500" max="500" value="0">
    </div>
    <div id="slider-bottom" class="slider-group">
      <label for="bottom-qr-vertical-offset">下QR位置調整</label>
      <input type="range" id="bottom-qr-vertical-offset" min="-500" max="500" value="0">
    </div>
    <div class="slider-group">
      <label for="qr-size">QRサイズ調整</label>
      <input type="range" id="qr-size" min="5" max="40" value="15">
    </div>
    <div class="slider-group">
      <label for="text-size">テキストサイズ調整</label>
      <input type="range" id="text-size" min="10" max="150" value="45">
    </div>
    <div class="slider-group">
      <label for="text-vertical-offset">テキスト縦位置調整</label>
      <input type="range" id="text-vertical-offset" min="-200" max="200" value="0">
    </div>

    <div class="controls-group">
      <button id="downloadButton">ダウンロード</button>
      <button id="resetButton" class="reset-btn">リセット</button>
    </div>
  </div>

<canvas id="canvas"></canvas>

<script>
// ===== 参照取得 =====
const mainInput = document.getElementById('mainInput');
const leftTopInput = document.getElementById('leftTopInput');
const rightTopInput = document.getElementById('rightTopInput');
const leftQRInput = document.getElementById('leftQRInput');
const rightQRInput = document.getElementById('rightQRInput');

const mainDrop = document.getElementById('mainDrop');
const leftTopDrop = document.getElementById('leftTopDrop');
const rightTopDrop = document.getElementById('rightTopDrop');
const leftQRDrop = document.getElementById('leftQRDrop');
const rightQRDrop = document.getElementById('rightQRDrop');

const mainThumb = document.getElementById('mainThumb');
const leftTopThumb = document.getElementById('leftTopThumb');
const rightTopThumb = document.getElementById('rightTopThumb');
const leftThumb = document.getElementById('leftThumb');
const rightThumb = document.getElementById('rightThumb');

const downloadButton = document.getElementById('downloadButton');
const resetButton = document.getElementById('resetButton');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const preview = document.getElementById('preview');

const leftQR_offset_input = document.getElementById('left-qr-offset');
const rightQR_offset_input = document.getElementById('right-qr-offset');
const topQRVerticalOffsetInput = document.getElementById('top-qr-vertical-offset');
const bottomQRVerticalOffsetInput = document.getElementById('bottom-qr-vertical-offset');
const qrSizeInput = document.getElementById('qr-size');
const textSizeInput = document.getElementById('text-size');
const textVerticalOffsetInput = document.getElementById('text-vertical-offset');

const toggleTextCheckbox = document.getElementById('toggleText');
const textColorPicker = document.getElementById('textColorPicker');
const leftTopText = document.getElementById('leftTopText');
const rightTopText = document.getElementById('rightTopText');
const leftQRText = document.getElementById('leftQRText');
const rightQRText = document.getElementById('rightQRText');

const modeSelect = document.getElementById('modeSelect');
const qrTopRow = document.getElementById('qr-top-row');
const qrBottomRow = document.getElementById('qr-bottom-row');
const sliderTop = document.getElementById('slider-top');
const sliderBottom = document.getElementById('slider-bottom');

// ===== 状態 =====
let leftQR_x_offset = 0;
let rightQR_x_offset = 0;
let topQRVerticalOffset = 0;
let bottomQRVerticalOffset = 0;
let textSize = 45;
let qrScale = 0.15; // 画像幅に対する比率（初期値 15%）
let textVerticalOffset = 0;

let mainImg = null, leftTopImg = null, rightTopImg = null, leftQRImg = null, rightQRImg = null;

// ===== 汎用: ドロップ＆選択 =====
function handleDrop(dropZone, input, thumb, setImage) {
  dropZone.addEventListener('click', () => input.click());
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.borderColor = '#00f'; });
  dropZone.addEventListener('dragleave', () => { dropZone.style.borderColor = '#e699b2'; });
  dropZone.addEventListener('drop', e => {
    e.preventDefault(); dropZone.style.borderColor = '#e699b2';
    if (e.dataTransfer.files.length) {
      const file = e.dataTransfer.files[0];
      input.files = e.dataTransfer.files;
      showThumb(file, thumb);
      loadImg(file, img => { setImage(img); merge(); });
    }
  });
  input.addEventListener('change', () => {
    if (input.files.length) {
      const file = input.files[0];
      showThumb(file, thumb);
      loadImg(file, img => { setImage(img); merge(); });
    }
  });
}

function showThumb(file, imgElem) {
  const reader = new FileReader();
  reader.onload = e => { imgElem.src = e.target.result; imgElem.style.display = 'block'; };
  reader.readAsDataURL(file);
}
function loadImg(file, cb) {
  const reader = new FileReader();
  reader.onload = e => { const img = new Image(); img.onload = () => cb(img); img.src = e.target.result; };
  reader.readAsDataURL(file);
}

// イベント紐付け
handleDrop(mainDrop, mainInput, mainThumb, img => mainImg = img);
handleDrop(leftTopDrop, leftTopInput, leftTopThumb, img => leftTopImg = img);
handleDrop(rightTopDrop, rightTopInput, rightTopThumb, img => rightTopImg = img);
handleDrop(leftQRDrop, leftQRInput, leftThumb, img => leftQRImg = img);
handleDrop(rightQRDrop, rightQRInput, rightThumb, img => rightQRImg = img);

// スライダー・入力
leftQR_offset_input.addEventListener('input', () => { leftQR_x_offset = parseInt(leftQR_offset_input.value); merge(); });
rightQR_offset_input.addEventListener('input', () => { rightQR_x_offset = parseInt(rightQR_offset_input.value); merge(); });
topQRVerticalOffsetInput.addEventListener('input', () => { topQRVerticalOffset = parseInt(topQRVerticalOffsetInput.value); merge(); });
bottomQRVerticalOffsetInput.addEventListener('input', () => { bottomQRVerticalOffset = parseInt(bottomQRVerticalOffsetInput.value); merge(); });
qrSizeInput.addEventListener('input', () => { qrScale = parseInt(qrSizeInput.value)/100; merge(); });
textSizeInput.addEventListener('input', () => { textSize = parseInt(textSizeInput.value); merge(); });
textVerticalOffsetInput.addEventListener('input', () => { textVerticalOffset = parseInt(textVerticalOffsetInput.value); merge(); });

toggleTextCheckbox.addEventListener('change', merge);
textColorPicker.addEventListener('input', merge);
[leftTopText, rightTopText, leftQRText, rightQRText].forEach(el => el.addEventListener('input', merge));

modeSelect.addEventListener('change', updateMode);

// ===== モード切替 =====
function updateMode() {
  const isTwo = (modeSelect.value === '2');
  qrTopRow.classList.remove('hidden');
  sliderTop.classList.remove('hidden');
  if (isTwo) {
    qrBottomRow.classList.add('hidden');
    sliderBottom.classList.add('hidden');
  } else {
    qrBottomRow.classList.remove('hidden');
    sliderBottom.classList.remove('hidden');
  }
  merge();
}

// 初期モード適用
updateMode();

// ===== 合成処理 =====
function merge() {
  if (!mainImg) { 
    preview.style.display = 'none'; 
    downloadButton.style.display = 'none'; 
    return; 
  }

  const W = mainImg.width;
  const H = mainImg.height;
  canvas.width = W; canvas.height = H;
  ctx.clearRect(0,0,W,H);
  ctx.drawImage(mainImg, 0, 0, W, H);

  const qrW = W * qrScale;
  const qrH = qrW;
  const margin = W * 0.02;
  const yTop = H * 0.2 + topQRVerticalOffset;
  const yBottomBase = H * 0.2 + bottomQRVerticalOffset;
  const verticalGap = H * 0.15;
  const textGap = 50 + textVerticalOffset;

  const showText = toggleTextCheckbox.checked;
  ctx.fillStyle = textColorPicker.value;
  ctx.font = `bold ${textSize}px Arial`;
  ctx.textAlign = 'center';

  const leftX = margin + 540 + leftQR_x_offset;
  const rightX = W - qrW - margin + rightQR_x_offset;

  if (modeSelect.value === '2') {
    if (leftTopImg) {
      ctx.drawImage(leftTopImg, leftX, yTop, qrW, qrH);
      if (showText) ctx.fillText(leftTopText.value, leftX + qrW/2, yTop - textGap);
    }
    if (rightTopImg) {
      ctx.drawImage(rightTopImg, rightX, yTop, qrW, qrH);
      if (showText) ctx.fillText(rightTopText.value, rightX + qrW/2, yTop - textGap);
    }
  } else {
    if (leftTopImg) {
      ctx.drawImage(leftTopImg, leftX, yTop, qrW, qrH);
      if (showText) ctx.fillText(leftTopText.value, leftX + qrW/2, yTop - textGap);
    }
    if (leftQRImg) {
      const yL = yBottomBase + verticalGap + (H * 0.3);
      ctx.drawImage(leftQRImg, leftX, yL, qrW, qrH);
      if (showText) ctx.fillText(leftQRText.value, leftX + qrW/2, yL - textGap);
    }
    if (rightTopImg) {
      ctx.drawImage(rightTopImg, rightX, yTop, qrW, qrH);
      if (showText) ctx.fillText(rightTopText.value, rightX + qrW/2, yTop - textGap);
    }
    if (rightQRImg) {
      const yR = yBottomBase + verticalGap + (H * 0.3);
      ctx.drawImage(rightQRImg, rightX, yR, qrW, qrH);
      if (showText) ctx.fillText(rightQRText.value, rightX + qrW/2, yR - textGap);
    }
  }

  preview.src = canvas.toDataURL('image/png');
  preview.style.display = 'block';
  downloadButton.style.display = 'inline-block';
}

// ===== ダウンロード =====
downloadButton.addEventListener('click', () => {
  if (!mainImg) return;
  const a = document.createElement('a');
  a.href = canvas.toDataURL('image/png');
  a.download = 'rootshare_合成.png';
  a.click();
});

// ===== リセット =====
function resetAll() {
  // 画像とサムネ
  [mainThumb, leftTopThumb, rightTopThumb, leftThumb, rightThumb].forEach(t => { t.src = ''; t.style.display = 'none'; });
  mainImg = leftTopImg = rightTopImg = leftQRImg = rightQRImg = null;
  // 入力初期化
  [mainInput, leftTopInput, rightTopInput, leftQRInput, rightQRInput].forEach(inp => inp.value = '');
  // テキスト
  leftTopText.value = '先１';
  rightTopText.value = '後１';
  leftQRText.value = '先２';
  rightQRText.value = '後２';
  // スイッチ・色
  toggleTextCheckbox.checked = true;
  textColorPicker.value = '#000000';
  // スライダー
  leftQR_offset_input.value = 0; rightQR_offset_input.value = 0;
  topQRVerticalOffsetInput.value = 0; bottomQRVerticalOffsetInput.value = 0;
  textSizeInput.value = 45; qrSizeInput.value = 15; textVerticalOffsetInput.value = 0;
  leftQR_x_offset = 0; rightQR_x_offset = 0; topQRVerticalOffset = 0; bottomQRVerticalOffset = 0;
  textSize = 45; qrScale = 0.15; textVerticalOffset = 0;
  // モード
  modeSelect.value = '2';
  updateMode();
  // プレビュー非表示
  preview.src = '';
  preview.style.display = 'none';
  downloadButton.style.display = 'none';
  // キャンバスクリア
  ctx.clearRect(0,0,canvas.width,canvas.height);
}
resetButton.addEventListener('click', resetAll);
</script>

</body>
</html>
