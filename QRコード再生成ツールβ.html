<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QRコード読み取り＆再生成ツール</title>
  <style>
    body {
      font-family: sans-serif;
      background: #1e1e1e;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 12px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    h1 {
      font-size: 1.2rem;
      color: #c084fc;
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin: 12px 0 6px;
      font-size: 0.9rem;
    }
    select, input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: none;
      margin-bottom: 10px;
      background: #3a3a3a;
      color: #fff;
    }
    .drop-zone {
      border: 2px dashed #666;
      padding: 20px;
      text-align: center;
      border-radius: 8px;
      color: #aaa;
      margin-bottom: 12px;
      cursor: pointer;
    }
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      margin-top: 8px;
      cursor: pointer;
      background: #a855f7;
      color: #fff;
    }
    .btn:hover {
      background: #9333ea;
    }
    #qrResult {
      margin: 16px 0;
      text-align: center;
    }
    #qrCanvas {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>QRコード読み取り＆再生成ツール</h1>

    <label for="mode">入力モード</label>
    <select id="mode">
      <option value="upload">アップロード</option>
      <option value="camera">カメラ</option>
    </select>

    <div id="uploadSection" class="drop-zone">
      ここに画像をドラッグ＆ドロップ<br>またはクリックで選択
      <input type="file" id="fileInput" accept="image/*" style="display:none">
    </div>

    <div id="cameraSection" style="display:none;">
      <video id="video" autoplay playsinline style="width:100%;border-radius:8px;"></video>
    </div>

    <label for="qrText">読み取った文字列</label>
    <input type="text" id="qrText" placeholder="ここに読み取った文字列が表示されます" readonly>

    <label for="ecLevel">誤り訂正レベル</label>
    <select id="ecLevel">
      <option value="L">L (低)</option>
      <option value="M" selected>M (中)</option>
      <option value="Q">Q (高)</option>
      <option value="H">H (最高)</option>
    </select>

    <label for="margin">余白 (0〜16px)</label>
    <input type="number" id="margin" min="0" max="16" value="4">

    <!-- 生成ボタン -->
    <button class="btn" id="generateBtn">QRを再生成</button>

    <!-- QR表示 -->
    <div id="qrResult">
      <canvas id="qrCanvas"></canvas>
    </div>

    <!-- 保存ボタン -->
    <button class="btn" id="saveBtn">PNG保存</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    const modeSelect = document.getElementById("mode");
    const uploadSection = document.getElementById("uploadSection");
    const cameraSection = document.getElementById("cameraSection");
    const fileInput = document.getElementById("fileInput");
    const video = document.getElementById("video");
    const qrText = document.getElementById("qrText");
    const generateBtn = document.getElementById("generateBtn");
    const saveBtn = document.getElementById("saveBtn");
    const qrCanvas = document.getElementById("qrCanvas");
    let stream;

    // 入力モード切替
    modeSelect.addEventListener("change", async () => {
      if (modeSelect.value === "camera") {
        uploadSection.style.display = "none";
        cameraSection.style.display = "block";
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          video.srcObject = stream;
          requestAnimationFrame(scanQRCode);
        } catch (err) {
          alert("カメラにアクセスできません: " + err.message);
        }
      } else {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        uploadSection.style.display = "block";
        cameraSection.style.display = "none";
      }
    });

    // ドラッグ＆ドロップ
    uploadSection.addEventListener("click", () => fileInput.click());
    uploadSection.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadSection.style.borderColor = "#a855f7";
    });
    uploadSection.addEventListener("dragleave", () => {
      uploadSection.style.borderColor = "#666";
    });
    uploadSection.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadSection.style.borderColor = "#666";
      if (e.dataTransfer.files.length) {
        handleFile(e.dataTransfer.files[0]);
      }
    });
    fileInput.addEventListener("change", (e) => {
      if (e.target.files.length) {
        handleFile(e.target.files[0]);
      }
    });

    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => decodeImage(img);
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function decodeImage(img) {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      if (code) {
        qrText.value = code.data;
      } else {
        alert("QRコードを検出できませんでした。");
      }
    }

    function scanQRCode() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if (code) {
          qrText.value = code.data;
          stream.getTracks().forEach(track => track.stop()); // 自動停止
          return;
        }
      }
      requestAnimationFrame(scanQRCode);
    }

    // QR生成
    generateBtn.addEventListener("click", () => {
      const text = qrText.value;
      if (!text) return alert("文字列が空です。");
      const ecLevel = document.getElementById("ecLevel").value;
      const margin = parseInt(document.getElementById("margin").value) || 0;

      QRCode.toCanvas(qrCanvas, text, {
        errorCorrectionLevel: ecLevel,
        margin: margin,
        width: 256,
        color: {
          dark: "#000000",
          light: "#ffffff"
        }
      }, (err) => {
        if (err) alert("QRコード生成に失敗しました");
      });
    });

    // 保存機能
    saveBtn.addEventListener("click", () => {
      const link = document.createElement("a");
      link.download = "qrcode.png";
      link.href = qrCanvas.toDataURL();
      link.click();
    });
  </script>
</body>
</html>







